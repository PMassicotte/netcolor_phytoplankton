---
title: "NetCOLOR project"
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    highlight: zenburn
    css: "theme.css"
    toc: true
    toc_float:
      collapsed: false
bibliography: references.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  cache = TRUE
)

library(here)
library(tidyverse)
library(kableExtra)

library(ggpmthemes)

# Set default ggplot2 font size and font family
# devtools::install_github("PMassicotte/ggpmthemes")
theme_set(theme_light_modified(
  base_family = "Poppins",
  base_size = 10
))

theme_update(
  panel.border = element_blank(),
  axis.ticks = element_blank(),
  strip.background = element_blank(),
  strip.text = element_text(face = "bold", size = 10, color = "#4c4a4a")
)

source(here("R","zzz.R"))
```

```{r open_data}
hplc <- vroom::vroom(here("data","clean","hplc.csv"))
metadata <- vroom::vroom(here("data","clean","metadata.csv"))
absorption <- vroom::vroom(here("data","clean","absorption.csv"))
```

This section shows some graphics about the processed data. The data consists in three `.csv` files:

1.  `metadata.csv`

2.  `hplc.csv`

3.  `absorption.csv`

`sample_id` *438116* was duplicated and removed from the data.

## Notes

-   Will be using `depth` instead of `pressure` to characterize the depth of the measurements.

-   Will be only using observations measured in the first 2 meters of the water column. All the following graphs will be using data measured between 0-2 meters.

```{r}
knitr::include_graphics(pdf2png(here("graphs","05_barplot_measurement_depth.pdf")))
```

## Mismatch between metadata, HPLC and absorption

Now, this table shows the metadata that have no HPLC values associated.

```{r}
metadata %>% 
  anti_join(hplc, by = "sample_id") %>% 
  rmarkdown::paged_table()
```

These are the absorption spectra with no HPLC association.

```{r}
absorption %>% 
  anti_join(hplc, by = "sample_id") %>% 
  distinct(sample_id, .keep_all = TRUE) %>% 
  rmarkdown::paged_table()
```

## First visualizations

Most of the data is from the Scotian Shelf, Labrador Sea and Scotian Shelf and Slope.

```{r}
knitr::include_graphics(pdf2png(here("graphs","06_number_measurements_cruise.pdf")))
```

The number of observation is also relatively stable through the years.

```{r}
knitr::include_graphics(pdf2png(here("graphs","06_number_measurements_per_year.pdf")))
```

## Bioregions

Observations were classified into bioregions based on the following criteria (where `position` is `south` if `latitude < 48`):

```{r, eval=FALSE, echo=TRUE}
bathymetry > -300 & position == "North" ~ "Labrador & Greenland Shelves (LGS)"
bathymetry <= -300 & position == "North" ~ "Labrador Sea Basin (LSB)"
bathymetry >= -300 & position == "South" & yday <= 180 ~ "Scotian Shelf Spring (SSSp)"
bathymetry >= -300 & position == "South" & yday > 180 ~ "Scotian Shelf Fall (SSFa)"
bathymetry < -300 & position == "South"~ "Northwest Atlantic Basin ocean (NAB)"
```

```{r}
knitr::include_graphics(pdf2png(here(
  "graphs", "04_number_observations_per_bioregion.pdf"
)))
```

## HPLC

-   I also noticed there are a lot of `0` in the HPLC data. After discussions, they are true `0` and not missing values.

```{r}
hplc %>%
  select(-abs_vol_l) %>%
  pivot_longer(chlb:zea) %>%
  drop_na() %>%
  mutate(is_zero = value == 0) %>% 
  count(name, is_zero) %>%
  ggplot(aes(x = n, y = name, fill = is_zero)) +
  geom_col() +
  paletteer::scale_fill_paletteer_d("ggthemes::wsj_colors6") +
  labs(
    y = NULL,
    fill = "Value\nis zero"
  ) 
```

-   Some HPLC `sample_id` were not numeric (ex.: FL002), I removed them from the data.

-   There are `hplchla` and `hplcchla` variables in the data. I have merge both columns into one because I suspect it is an error and should be the same variable.

-   `but19` was summed as `but19` + `butlike`.

-   `hex19` was summed as `hex19` + `hexlike` + `hexlike2`.

-   I have calculated `aphy_specific` using `hplcchla`.

-   Here is an attempt to visualize the seasonal cycle of few pigments. I have calculated the average pigment concentration and then the average total concentration to finally calculate the relative average contribution of each pigment.

```{r}
knitr::include_graphics(pdf2png(here("graphs","10_hplc_month_bioregion.pdf")))
```

## Absorption

-   Here is how I named absorption data:

    -   `anap` is the data contained in files with `detritus` in their name.
    -   `ap` is the data contained in files with `particulate` in their name.
    -   `aphy` is the data contained in files with `phytoplankton` in their name.

-   Absorption spectra with any values \<= 0 between 350 and 400 nm have been removed.

-   Absorption spectra with `aphy(440)` \< `aphy(410)` have been removed (possible problem with pigment extraction).

#### ap

```{r}
knitr::include_graphics(pdf2png(here("graphs","07_ap_spectral_profiles_per_bioregion.pdf")))
```

#### aphy

```{r}
knitr::include_graphics(pdf2png(here("graphs","07_aphy_spectral_profiles_per_bioregion.pdf")))
```

#### aphy specific

```{r}
knitr::include_graphics(pdf2png(here("graphs","07_aphy_specific_spectral_profiles_per_bioregion.pdf")))
```

We can observe that there is a specific absorption gradient among bioregions.

```{r}
knitr::include_graphics(pdf2png(here("graphs","07_sina_plot_aphy_specific_443nm.pdf")))
```

#### anap

```{r}
knitr::include_graphics(pdf2png(here("graphs","07_anap_spectral_profiles_per_bioregion.pdf")))
```

### Calculating snap

> The fit was done for data between 380 and 730 nm, excluding the 400--480 and 620--710 nm ranges to avoid any residual pigment absorption that might still have been present after sodium hypochlorite treatment [@Babin2003].

A R2 of 0.90 was used to filter out bad models.

```{r}
knitr::include_graphics(pdf2png(here("graphs","02_non_algal_absorption_spectra_vs_fitted.pdf")))
```

## Preliminary analysis

### Seasonal cycle

-   The next figure shows how many observations there are for each year of the day. We can see that there are temporal gaps in the data. For example, in `Labrador & Greenland Shelves (LGS)`, there are only data in May/June. It is not enough to get insights on the seasonal cycles. At the moment, I am not sure how to deal with that.

```{r}
knitr::include_graphics(pdf2png(here("graphs","08_number_observations_per_yday_bioregion.pdf")))
```

-   A first attempt can be by using boxplots to see if there are differences among months and bioregions.

```{r}
knitr::include_graphics(pdf2png(here("graphs","08_boxplot_aphy_specific_by_month_bioregion.pdf")))
```

-   Another way to visualize the same data.

```{r}
knitr::include_graphics(pdf2png(here("graphs","08_boxplot_aphy_specific_by_month_bioregion2.pdf")))
```

-   We can also look at the seasonal variability by bioregion. There are interesting patterns in the data. For instance, in `Northwest Atlantic Basin ocean (NAB)` we can clearly see the seasonal pattern of `hex19`.

```{r}
knitr::include_graphics(pdf2png(here("graphs","08_boxplot_hex19_by_month_bioregion.pdf")))
```

### Phytoplankton population model

Explore and try to understand the method of Emmanuel that aims to decompose absorption spectra into two populations.

```{r}
knitr::include_graphics(pdf2png(here("graphs","11_hplc_chla_vs_phyto_absorption.pdf")))
```

```{r}
knitr::include_graphics(pdf2png(here("graphs","11_s_vs_wavelength.pdf")))
```

```{r}
knitr::include_graphics(pdf2png(here("graphs","11_as1_as2_vs_wavelength.pdf")))
```

### Bricaud 1995

In this section, I put our data in the context of the paper by @Bricaud1995.

-   In table 2, they provide coefficients to fit $a^*_\phi$ as a function of chlorophyll-a between 400 and 700 nm. The next figure shows some randomly selected spectral profiles of $a^*_\phi$ and compare them with those modeled using the coefficients presented in @Bricaud1995.

```{r}
knitr::include_graphics(pdf2png(here("graphs","12_specific_phytoplankton_absorption_spectra_vs_fitted.pdf")))
```

-   The next figure shows $a^*_\phi$ modeled at different wavelengths using the following equation:

$$
a^*_\phi(\lambda) = A(\lambda)\times\text{chl-a}^{-B(\lambda)}
$$

```{r}
knitr::include_graphics(pdf2png(here("graphs","12_specific_phytoplankton_absorption_vs_chla_bricaud_1995_figure01.pdf")))
```

## Fucoxanthin bining

```{r}
knitr::include_graphics(pdf2png(here(
  "graphs", "13_boxplot_percentage_fucoxanthin.pdf"
)))
```

```{r}
knitr::include_graphics(pdf2png(
  here(
    "graphs",
    "13_barplot_number_observations_bining_fucoxanthin.pdf"
  )
))
```

```{r}
knitr::include_graphics(pdf2png(
  here(
    "graphs",
    "13_mean_specific_phytoplankton_absorption_bining_fucoxanthin.pdf"
  )
))
```

### Relationships between fucoxanthin relative content and absorption

```{r}
knitr::include_graphics(pdf2png(
  here(
    "graphs",
    "13_scatterplot_percent_fucoxanthin_aphy_specific.pdf"
  )
))
```

Based on the *linear* relationships in the previous graph, this shows the R2 as a function of the wavelength.

```{r}
knitr::include_graphics(pdf2png(
  here("graphs", "13_r2_percent_fucoxanthin_vs_aphy_specific.pdf")
))
```

## Apparent visible wavelength (AVW)

In this section we explore how the Apparent visible wavelength (AVW) could be used to describe the spectral shape of phytoplankton absorption. The AVW index is calculated following [@vandermeulen2020].

```{r}
knitr::include_graphics(pdf2png(
  here("graphs", "14_boxplot_avw_by_bioregions.pdf")
))
```

This graph shows all the phytoplankton absorption spectra colored by the value of the calculated AVW.

```{r}
knitr::include_graphics(pdf2png(
  here("graphs", "14_normalized_aphy_avw_colored.pdf")
))
```

```{r}
knitr::include_graphics(pdf2png(
  here("graphs", "14_aphy_spectra_highest_avw_difference.pdf")
))
```

```{r}
knitr::include_graphics(pdf2png(
  here("graphs", "14_scatterplot_chla_vs_avw.pdf")
))
```

## Figures for the manuscript

### Figure 1

```{r}
knitr::include_graphics(pdf2png(here("graphs","fig01.pdf")))
```

### Figure 2

- Within each panel, we can see the averaged spectra and a subset of 100 randomly selected spectra by bioregion and type of absorption.

```{r}
knitr::include_graphics(pdf2png(here("graphs", "fig02.pdf")))
```

### Figure 3

```{r}
knitr::include_graphics(pdf2png(here("graphs", "fig03.pdf")))
```

### Figure 4

```{r}
knitr::include_graphics(pdf2png(here("graphs", "fig04.pdf")))
```

### Figure 5

> The observed nonlinearity between Chl_a and the ratio of phytoplankton absorption aph (443)/aph (670) indicating the packaging effect and changes in the intercellular composition of pigments.

```{r}
knitr::include_graphics(pdf2png(here("graphs", "fig05.pdf")))
```

### Figure 6

```{r}
knitr::include_graphics(pdf2png(here("graphs", "fig06.pdf")))
```

### Figure 7

Horizontal black lines in B show the 2.5%, 50% and 97.5% quantiles.

```{r}
knitr::include_graphics(pdf2png(here("graphs", "fig07.pdf")))
```

### Figure 8

```{r}
knitr::include_graphics(pdf2png(here("graphs", "fig08.pdf")))
```

### Figure 9

```{r}
knitr::include_graphics(pdf2png(here("graphs", "fig09.pdf")))
```

### Figure 10

```{r}
knitr::include_graphics(pdf2png(here("graphs", "fig10.pdf")))
```

## Appendix

### Appendix 1

**Attention**: These numbers are based on the total number of reported stations. For example, in 2019, there are a total of 217 stations, but only 71 of them have absorption measurements.

```{r}
knitr::include_graphics(pdf2png(here("graphs", "appendix01.pdf")))
```

### Appendix 2

Numbers at the right represent: mean (min - max).

```{r}
knitr::include_graphics(pdf2png(here("graphs", "appendix02.pdf")))
```

### Appendix 3

Phytoplankton specific absorption measured in autumn and winter in the Labrador Sea.

```{r}
knitr::include_graphics(pdf2png(here("graphs", "appendix03.pdf")))
```

### Appendix 4

```{r}
knitr::include_graphics(pdf2png(here("graphs", "appendix04.pdf")))
```

### Appendix 5

```{r}
knitr::include_graphics(pdf2png(here("graphs", "appendix05.pdf")))
```

## References
